#CI can be calculated via the bootstrap (or asymptotic approximation)
######################################################################################################
############ IPTW with models ########################
######################################################################################################
### Fit a logistic regression model for the propensity score
rhc.data$age.sqrd <- rhc.data$age^2
fit.PS <- glm(treatment ~ female + ARF + age + age.sqrd + sepsis, data = rhc.data, family = "binomial")
summary(fit.PS)
PS.all <- vector(length=n.sample)
PS.all[rhc.data$treatment==1] <- fit.PS$fitted.values[rhc.data$treatment==1]
PS.all[rhc.data$treatment==0] <- fit.PS$fitted.values[rhc.data$treatment==0]
summary(PS.all)
# fitted.values is the same as predict(fit.PS,type = "response")
### Add the PS to the dataset for plotting
rhc.data$PS <- PS.all
ggplot(rhc.data, aes(x = PS, fill = factor(female))) + theme_bw() + geom_density(alpha = 0.3)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(~female)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(sepsis~female)
#
###### ### Calculate ATE ######
#### IPTW using logistic regression for the weights####
w.i.logit <- vector(length = n.sample)
w.i.logit[rhc.data$treatment==1] <- 1/PS.all[rhc.data$treatment==1]
w.i.logit[rhc.data$treatment==0] <- 1/(1 - PS.all[rhc.data$treatment==0])
hist(w.i.logit)
#### Causal Inference - Lecture 3
library(tidyverse)
library(ggplot2)
rm(list = ls())
setwd("/Users/danielnevo/Dropbox/TAU/Teaching/Causal Inference/CausalCourseR/Data/rhc/")
# load data
rhc.data <- read.csv2("rhc.csv")
##### First quick look at the variables #####
str(rhc.data)
summary(rhc.data)
######################################################################################################
##### Naive ATE estimator #####
######################################################################################################
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(m = mean(death)) %>%
dplyr::summarize(naive.ATE = m[2]-m[1])
# Or in the more traditional way
m.trt <- mean(rhc.data$death[rhc.data$treatment==1]) # trt stands for "treatment"
m.ctrl <- mean(rhc.data$death[rhc.data$treatment==0]) # ctrl stands for "control"
naive.ATE <- m.trt - m.ctrl
naive.ATE
# Treatment increases the probability of death by 5% (if all patients had rhc on day 1 vs. not)
emo::ji("thinking");emo::ji("astonished")
# Confidence interval using asymptotic variance. Note that the outcome here is binary
# Which of the following three variables is a good candidate?
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(prop.ARF = mean(ARF), prop.sepsis = mean(sepsis), prop.female = mean(female))
# Taking sepsis only as our sample covariate, estimate the propensity score for each value
ps.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==1])
ps.no.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==0])
ps.sepsis
ps.no.sepsis
#### Causal Inference - Lecture 3
library(tidyverse)
library(ggplot2)
rm(list = ls())
> line <- "Hello World"
line <- "Hello World"
line
install.packages("tidyverse")
#### Causal Inference - Lecture 3
library(tidyverse)
library(ggplot2)
rm(list = ls())
setwd("~/git/Education/causal-inference/")
# load data
rhc.data <- read.csv2("rhc.csv")
rhc
ehc.data
rhc.data
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(m = mean(death)) %>%
dplyr::summarize(naive.ATE = m[2]-m[1])
# Or in the more traditional way
m.trt <- mean(rhc.data$death[rhc.data$treatment==1]) # trt stands for "treatment"
m.ctrl <- mean(rhc.data$death[rhc.data$treatment==0]) # ctrl stands for "control"
naive.ATE <- m.trt - m.ctrl
naive.ATE
# Treatment increases the probability of death by 5% (if all patients had rhc on day 1 vs. not)
emo::ji("thinking");emo::ji("astonished")
# Confidence interval using asymptotic variance. Note that the outcome here is binary
# Which of the following three variables is a good candidate?
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(prop.ARF = mean(ARF), prop.sepsis = mean(sepsis), prop.female = mean(female))
# Taking sepsis only as our sample covariate, estimate the propensity score for each value
ps.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==1])
ps.no.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==0])
ps.sepsis
ps.no.sepsis
# What does it mean about positivity?
# Calculate the estimated propensity scores and the weights
# Probably can be written in less lines (e.g., using ifelse)
n.sample <- nrow(rhc.data)
ps <- vector(length = n.sample)
ps[rhc.data$sepsis==1] <- ps.sepsis
ps[rhc.data$sepsis==0] <- ps.no.sepsis
w.i <- vector(length = n.sample)
w.i[rhc.data$treatment==1] <- 1/ps[rhc.data$treatment==1]
w.i[rhc.data$treatment==0] <- 1/(1 - ps[rhc.data$treatment==0])
w.i
w.i[rhc.data$treatment==0]
w.i[rhc.data$treatment==1]
ps
View(rhc.data)
rhc.data <- read.csv2("rhc.csv")
View(rhc.data)
rhc.data <- read.csv("rhc.csv")
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(m = mean(death)) %>%
dplyr::summarize(naive.ATE = m[2]-m[1])
# Or in the more traditional way
m.trt <- mean(rhc.data$death[rhc.data$treatment==1]) # trt stands for "treatment"
m.ctrl <- mean(rhc.data$death[rhc.data$treatment==0]) # ctrl stands for "control"
naive.ATE <- m.trt - m.ctrl
naive.ATE
# Treatment increases the probability of death by 5% (if all patients had rhc on day 1 vs. not)
emo::ji("thinking");emo::ji("astonished")
# Confidence interval using asymptotic variance. Note that the outcome here is binary
# Which of the following three variables is a good candidate?
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(prop.ARF = mean(ARF), prop.sepsis = mean(sepsis), prop.female = mean(female))
# Taking sepsis only as our sample covariate, estimate the propensity score for each value
ps.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==1])
ps.no.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==0])
ps.sepsis
ps.no.sepsis
n.sample <- nrow(rhc.data)
ps <- vector(length = n.sample)
ps[rhc.data$sepsis==1] <- ps.sepsis
ps[rhc.data$sepsis==0] <- ps.no.sepsis
w.i <- vector(length = n.sample)
w.i[rhc.data$treatment==1] <- 1/ps[rhc.data$treatment==1]
w.i[rhc.data$treatment==0] <- 1/(1 - ps[rhc.data$treatment==0])
w.i
ps
rhc.data$PS <- PS.all
ggplot(rhc.data, aes(x = PS, fill = factor(female))) + theme_bw() + geom_density(alpha = 0.3)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(~female)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(sepsis~female)
PS.all <- vector(length=n.sample)
PS.all[rhc.data$treatment==1] <- fit.PS$fitted.values[rhc.data$treatment==1]
PS.all[rhc.data$treatment==0] <- fit.PS$fitted.values[rhc.data$treatment==0]
summary(PS.all)
# fitted.values is the same as predict(fit.PS,type = "response")
### Add the PS to the dataset for plotting
rhc.data$PS <- PS.all
ggplot(rhc.data, aes(x = PS, fill = factor(female))) + theme_bw() + geom_density(alpha = 0.3)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(~female)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(sepsis~female)
#### Causal Inference - Lecture 3
library(tidyverse)
library(ggplot2)
rm(list = ls())
setwd("/Users/danielnevo/Dropbox/TAU/Teaching/Causal Inference/CausalCourseR/Data/rhc/")
# load data
rhc.data <- read.csv2("rhc.csv")
##### First quick look at the variables #####
str(rhc.data)
summary(rhc.data)
######################################################################################################
##### Naive ATE estimator #####
######################################################################################################
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(m = mean(death)) %>%
dplyr::summarize(naive.ATE = m[2]-m[1])
# Or in the more traditional way
m.trt <- mean(rhc.data$death[rhc.data$treatment==1]) # trt stands for "treatment"
m.ctrl <- mean(rhc.data$death[rhc.data$treatment==0]) # ctrl stands for "control"
naive.ATE <- m.trt - m.ctrl
naive.ATE
# Treatment increases the probability of death by 5% (if all patients had rhc on day 1 vs. not)
emo::ji("thinking");emo::ji("astonished")
# Confidence interval using asymptotic variance. Note that the outcome here is binary
# Which of the following three variables is a good candidate?
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(prop.ARF = mean(ARF), prop.sepsis = mean(sepsis), prop.female = mean(female))
# Taking sepsis only as our sample covariate, estimate the propensity score for each value
ps.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==1])
ps.no.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==0])
ps.sepsis
ps.no.sepsis
# What does it mean about positivity?
# Calculate the estimated propensity scores and the weights
# Probably can be written in less lines (e.g., using ifelse)
n.sample <- nrow(rhc.data)
ps <- vector(length = n.sample)
ps[rhc.data$sepsis==1] <- ps.sepsis
ps[rhc.data$sepsis==0] <- ps.no.sepsis
w.i <- vector(length = n.sample)
w.i[rhc.data$treatment==1] <- 1/ps[rhc.data$treatment==1]
w.i[rhc.data$treatment==0] <- 1/(1 - ps[rhc.data$treatment==0])
#
ATE.IPTW <- sum(w.i[rhc.data$treatment==1]*rhc.data$death[rhc.data$treatment==1])/n.sample -
sum(w.i[rhc.data$treatment==0]*rhc.data$death[rhc.data$treatment==0])/n.sample
ATE.IPTW
#CI can be calculated via the bootstrap (or asymptotic approximation)
######################################################################################################
############ IPTW with models ########################
######################################################################################################
### Fit a logistic regression model for the propensity score
rhc.data$age.sqrd <- rhc.data$age^2
fit.PS <- glm(treatment ~ female + ARF + age + age.sqrd + sepsis, data = rhc.data, family = "binomial")
summary(fit.PS)
PS.all <- vector(length=n.sample)
PS.all[rhc.data$treatment==1] <- fit.PS$fitted.values[rhc.data$treatment==1]
PS.all[rhc.data$treatment==0] <- fit.PS$fitted.values[rhc.data$treatment==0]
summary(PS.all)
# fitted.values is the same as predict(fit.PS,type = "response")
### Add the PS to the dataset for plotting
rhc.data$PS <- PS.all
ggplot(rhc.data, aes(x = PS, fill = factor(female))) + theme_bw() + geom_density(alpha = 0.3)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(~female)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(sepsis~female)
#
#### Causal Inference - Lecture 3
library(tidyverse)
library(ggplot2)
rm(list = ls())
setwd("/Users/danielnevo/Dropbox/TAU/Teaching/Causal Inference/CausalCourseR/Data/rhc/")
# load data
rhc.data <- read.csv2("rhc.csv")
##### First quick look at the variables #####
str(rhc.data)
summary(rhc.data)
######################################################################################################
##### Naive ATE estimator #####
######################################################################################################
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(m = mean(death)) %>%
dplyr::summarize(naive.ATE = m[2]-m[1])
# Or in the more traditional way
m.trt <- mean(rhc.data$death[rhc.data$treatment==1]) # trt stands for "treatment"
m.ctrl <- mean(rhc.data$death[rhc.data$treatment==0]) # ctrl stands for "control"
naive.ATE <- m.trt - m.ctrl
naive.ATE
# Treatment increases the probability of death by 5% (if all patients had rhc on day 1 vs. not)
emo::ji("thinking");emo::ji("astonished")
# Confidence interval using asymptotic variance. Note that the outcome here is binary
# Which of the following three variables is a good candidate?
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(prop.ARF = mean(ARF), prop.sepsis = mean(sepsis), prop.female = mean(female))
# Taking sepsis only as our sample covariate, estimate the propensity score for each value
ps.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==1])
ps.no.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==0])
ps.sepsis
ps.no.sepsis
# What does it mean about positivity?
# Calculate the estimated propensity scores and the weights
# Probably can be written in less lines (e.g., using ifelse)
n.sample <- nrow(rhc.data)
ps <- vector(length = n.sample)
ps[rhc.data$sepsis==1] <- ps.sepsis
ps[rhc.data$sepsis==0] <- ps.no.sepsis
w.i <- vector(length = n.sample)
w.i[rhc.data$treatment==1] <- 1/ps[rhc.data$treatment==1]
w.i[rhc.data$treatment==0] <- 1/(1 - ps[rhc.data$treatment==0])
#
ATE.IPTW <- sum(w.i[rhc.data$treatment==1]*rhc.data$death[rhc.data$treatment==1])/n.sample -
sum(w.i[rhc.data$treatment==0]*rhc.data$death[rhc.data$treatment==0])/n.sample
ATE.IPTW
#CI can be calculated via the bootstrap (or asymptotic approximation)
######################################################################################################
############ IPTW with models ########################
######################################################################################################
### Fit a logistic regression model for the propensity score
rhc.data$age.sqrd <- rhc.data$age^2
fit.PS <- glm(treatment ~ female + ARF + age + age.sqrd + sepsis, data = rhc.data, family = "binomial")
summary(fit.PS)
PS.all <- vector(length=n.sample)
PS.all[rhc.data$treatment==1] <- fit.PS$fitted.values[rhc.data$treatment==1]
PS.all[rhc.data$treatment==0] <- fit.PS$fitted.values[rhc.data$treatment==0]
summary(PS.all)
# fitted.values is the same as predict(fit.PS,type = "response")
### Add the PS to the dataset for plotting
rhc.data$PS <- PS.all
ggplot(rhc.data, aes(x = PS, fill = factor(female))) + theme_bw() + geom_density(alpha = 0.3)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(~female)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(sepsis~female)
#
#### Causal Inference - Lecture 3
library(tidyverse)
library(ggplot2)
rm(list = ls())
setwd("/Users/danielnevo/Dropbox/TAU/Teaching/Causal Inference/CausalCourseR/Data/rhc/")
# load data
rhc.data <- read.csv("rhc.csv")
##### First quick look at the variables #####
str(rhc.data)
summary(rhc.data)
######################################################################################################
##### Naive ATE estimator #####
######################################################################################################
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(m = mean(death)) %>%
dplyr::summarize(naive.ATE = m[2]-m[1])
# Or in the more traditional way
m.trt <- mean(rhc.data$death[rhc.data$treatment==1]) # trt stands for "treatment"
m.ctrl <- mean(rhc.data$death[rhc.data$treatment==0]) # ctrl stands for "control"
naive.ATE <- m.trt - m.ctrl
naive.ATE
# Treatment increases the probability of death by 5% (if all patients had rhc on day 1 vs. not)
emo::ji("thinking");emo::ji("astonished")
# Confidence interval using asymptotic variance. Note that the outcome here is binary
# Which of the following three variables is a good candidate?
rhc.data %>%  group_by(treatment) %>%
dplyr::summarize(prop.ARF = mean(ARF), prop.sepsis = mean(sepsis), prop.female = mean(female))
# Taking sepsis only as our sample covariate, estimate the propensity score for each value
ps.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==1])
ps.no.sepsis <- mean(rhc.data$treatment[rhc.data$sepsis==0])
ps.sepsis
ps.no.sepsis
# What does it mean about positivity?
# Calculate the estimated propensity scores and the weights
# Probably can be written in less lines (e.g., using ifelse)
n.sample <- nrow(rhc.data)
ps <- vector(length = n.sample)
ps[rhc.data$sepsis==1] <- ps.sepsis
ps[rhc.data$sepsis==0] <- ps.no.sepsis
w.i <- vector(length = n.sample)
w.i[rhc.data$treatment==1] <- 1/ps[rhc.data$treatment==1]
w.i[rhc.data$treatment==0] <- 1/(1 - ps[rhc.data$treatment==0])
#
ATE.IPTW <- sum(w.i[rhc.data$treatment==1]*rhc.data$death[rhc.data$treatment==1])/n.sample -
sum(w.i[rhc.data$treatment==0]*rhc.data$death[rhc.data$treatment==0])/n.sample
ATE.IPTW
#CI can be calculated via the bootstrap (or asymptotic approximation)
######################################################################################################
############ IPTW with models ########################
######################################################################################################
### Fit a logistic regression model for the propensity score
rhc.data$age.sqrd <- rhc.data$age^2
fit.PS <- glm(treatment ~ female + ARF + age + age.sqrd + sepsis, data = rhc.data, family = "binomial")
summary(fit.PS)
PS.all <- vector(length=n.sample)
PS.all[rhc.data$treatment==1] <- fit.PS$fitted.values[rhc.data$treatment==1]
PS.all[rhc.data$treatment==0] <- fit.PS$fitted.values[rhc.data$treatment==0]
summary(PS.all)
# fitted.values is the same as predict(fit.PS,type = "response")
### Add the PS to the dataset for plotting
rhc.data$PS <- PS.all
ggplot(rhc.data, aes(x = PS, fill = factor(female))) + theme_bw() + geom_density(alpha = 0.3)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(~female)
ggplot(rhc.data, aes(x = PS, fill = factor(treatment))) + theme_bw() + geom_density(alpha = 0.3) + facet_wrap(sepsis~female)
#
